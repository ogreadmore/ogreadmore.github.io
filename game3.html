<!DOCTYPE html>
<html>
<head>
    <title>Space Haters</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #000;
            position: relative;
            height: 100vh;
            width: 100vw;
        }

        #gameCanvas {
            position: absolute;
            top: 0;
            left: 0;
            z-index: 5;
        }

        #backgroundCanvas {
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1;
        }

        /* Scoreboard Styles */
        #scoreboard {
            position: absolute;
            top: 5%;
            left: 5%;
            color: magenta;
            font-family: 'Press Start 2P', cursive;
            font-size: 3vh;
            user-select: none;
            z-index: 10;
            text-align: left;
        }

        #scoreboard .title {
            font-size: 4vh;
            margin-bottom: 10px;
        }

        #scoreboard .score {
            font-size: 2.5vh;
            margin-bottom: 20px; /* Added space between score and level */
        }

        /* Game Over and Restart Button Styles */
        #gameOver {
            position: absolute;
            top: 40%;
            width: 100%;
            text-align: center;
            font-size: 6vh;
            color: magenta;
            display: none;
            z-index: 15;
            pointer-events: none;
            font-family: 'Press Start 2P', cursive;
        }

        #restartButton {
            position: absolute;
            top: 55%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: transparent;
            color: magenta;
            padding: 15px 30px;
            border: 3px solid magenta;
            border-radius: 5px;
            cursor: pointer;
            font-family: 'Press Start 2P', cursive;
            font-size: 2rem;
            user-select: none;
            z-index: 15;
            display: none;
        }

        #restartButton:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        /* Start Button Styles */
        #startButton {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: transparent;
            color: magenta;
            padding: 20px 40px;
            border: 3px solid magenta;
            border-radius: 5px;
            cursor: pointer;
            font-family: 'Press Start 2P', cursive;
            font-size: 2rem;
            user-select: none;
            z-index: 15;
        }

        #startButton:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        /* Level Message Styles */
        .levelMessage {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: magenta;
            font-family: 'Press Start 2P', cursive;
            font-size: 5vh;
            user-select: none;
            z-index: 15;
            opacity: 0;
            transition: opacity 1s ease-in-out;
        }

        /* Joystick Styles */
        #leftJoystickContainer, #rightJoystickContainer {
            position: absolute;
            bottom: 20%;
            width: 200px;
            height: 200px;
            z-index: 20;
            display: none;
            opacity: 0.5;
            touch-action: none;
        }

        #leftJoystickContainer {
            left: 10%;
        }

        #rightJoystickContainer {
            right: 10%;
        }

        #leftJoystickBase, #rightJoystickBase {
            position: absolute;
            width: 100%;
            height: 100%;
            background-color: #ccc;
            border-radius: 50%;
            opacity: 0.3;
        }

        #leftJoystickThumb, #rightJoystickThumb {
            position: absolute;
            width: 80px; /* Adjusted size */
            height: 80px; /* Adjusted size */
            background-color: #fff;
            border-radius: 50%;
            top: 60px; /* Centered based on new sizes */
            left: 60px; /* Centered based on new sizes */
        }

        /* Show Joystick and Adjustments on Mobile Devices */
        @media (hover: none) and (pointer: coarse) {
            #leftJoystickContainer, #rightJoystickContainer {
                display: block;
            }

            /* Double the size of the heart ship */
            .mobile-heart {
                font-size: 120px !important;
            }

            /* Adjust Start and Restart Buttons for Mobile */
            #startButton, #restartButton {
                font-size: 1.5rem;
                padding: 10px 20px;
            }

            /* Adjust Scoreboard for Mobile */
            #scoreboard .title {
                font-size: 3vh;
            }

            #scoreboard .score {
                font-size: 2vh;
            }

            #gameOver {
                font-size: 4vh;
            }
        }
    </style>
    <!-- Include the Press Start 2P font -->
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Scoreboard -->
    <div id="scoreboard">
        <div class="title">space haters</div>
        <div class="score">score: 0</div>
        <div class="level">level: 1</div>
    </div>
    <!-- Game Over and Restart Button -->
    <div id="gameOver">game over</div>
    <div id="restartButton">restart</div>
    <!-- Start Button -->
    <div id="startButton">start game</div>
    <!-- Background Canvas -->
    <canvas id="backgroundCanvas"></canvas>
    <!-- Game Canvas -->
    <canvas id="gameCanvas"></canvas>
    <!-- Joysticks for Mobile Devices -->
    <div id="leftJoystickContainer">
        <div id="leftJoystickBase"></div>
        <div id="leftJoystickThumb"></div>
    </div>
    <div id="rightJoystickContainer">
        <div id="rightJoystickBase"></div>
        <div id="rightJoystickThumb"></div>
    </div>
    <script>
        // Initialize variables
        var gameStarted = false;
        var gameOver = false;

        // Get the canvases and contexts
        var backgroundCanvas = document.getElementById('backgroundCanvas');
        var bgCtx = backgroundCanvas.getContext('2d');

        var canvas = document.getElementById('gameCanvas');
        var ctx = canvas.getContext('2d');

        // Resize canvases to fit the window
        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            backgroundCanvas.width = window.innerWidth;
            backgroundCanvas.height = window.innerHeight;
            initStars(); // Reinitialize stars on resize
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        // Starfield variables
        var stars = [];
        var numStars = 200;

        function initStars() {
            stars = [];
            for (var i = 0; i < numStars; i++) {
                stars.push({
                    x: Math.random() * backgroundCanvas.width,
                    y: Math.random() * backgroundCanvas.height,
                    z: Math.random() * backgroundCanvas.width
                });
            }
        }

        function moveStars() {
            for (var i = 0; i < stars.length; i++) {
                stars[i].z -= 2;
                if (stars[i].z <= 0) {
                    stars[i].x = Math.random() * backgroundCanvas.width;
                    stars[i].y = Math.random() * backgroundCanvas.height;
                    stars[i].z = backgroundCanvas.width;
                }
            }
        }

        function drawStars() {
            bgCtx.fillStyle = 'black';
            bgCtx.fillRect(0, 0, backgroundCanvas.width, backgroundCanvas.height);
            bgCtx.fillStyle = 'white';
            for (var i = 0; i < stars.length; i++) {
                var k = 128.0 / stars[i].z;
                var x = (stars[i].x - backgroundCanvas.width / 2) * k + backgroundCanvas.width / 2;
                var y = (stars[i].y - backgroundCanvas.height / 2) * k + backgroundCanvas.height / 2;
                if (x >= 0 && x <= backgroundCanvas.width && y >= 0 && y <= backgroundCanvas.height) {
                    var size = (1 - stars[i].z / backgroundCanvas.width) * 2;
                    bgCtx.fillRect(x, y, size, size);
                }
            }
        }

        function animateBackground() {
            moveStars();
            drawStars();
            requestAnimationFrame(animateBackground);
        }

        initStars();
        animateBackground();

        // Game variables
        var player = {
            x: canvas.width / 2,
            y: canvas.height / 2,
            angle: 0,
            shootAngle: 0, // Added for gun direction
            speed: 0,
            rotation: 0,
            score: 0,
            level: 1,
            fireRate: 300, // milliseconds between shots
            lastShotTime: 0,
            projectileSize: 20,
            size: 60, // Increased size
            firepower: 1 // Number of heart-eye faces collected
        };

        var initialPlayerState = JSON.parse(JSON.stringify(player)); // For resetting weapon

        var projectiles = [];
        var enemies = [];
        var keys = {};
        var mouse = {
            x: canvas.width / 2,
            y: canvas.height / 2,
            leftDown: false
        };

        var leftJoystick = {
            active: false,
            identifier: null,
            startX: 0,
            startY: 0,
            x: 0,
            y: 0
        };

        var rightJoystick = {
            active: false,
            identifier: null,
            startX: 0,
            startY: 0,
            x: 0,
            y: 0
        };

        var lastTime = 0;
        var enemySpawnRate = 2000; // milliseconds between spawns
        var lastEnemySpawnTime = 0;
        var enemySizeMultiplier = 1; // Enemies get larger each level

        var largeAsteroidsDestroyed = 0; // Counter for large asteroids destroyed

        // Event listeners for controls
        // Keyboard controls
        document.addEventListener('keydown', function(e) {
            keys[e.code] = true;
        });

        document.addEventListener('keyup', function(e) {
            keys[e.code] = false;
        });

        // Mouse controls
        canvas.addEventListener('mousemove', function(e) {
            var rect = canvas.getBoundingClientRect();
            mouse.x = e.clientX - rect.left;
            mouse.y = e.clientY - rect.top;

            // Update shooting angle
            var dx = mouse.x - player.x;
            var dy = mouse.y - player.y;
            player.shootAngle = Math.atan2(dy, dx);
        });

        canvas.addEventListener('mousedown', function(e) {
            e.preventDefault();
            if (e.button === 0) {
                mouse.leftDown = true;
            }
        });

        canvas.addEventListener('mouseup', function(e) {
            e.preventDefault();
            if (e.button === 0) {
                mouse.leftDown = false;
            }
        });

        // Joystick controls
        var leftJoystickContainer = document.getElementById('leftJoystickContainer');
        var leftJoystickThumb = document.getElementById('leftJoystickThumb');

        var rightJoystickContainer = document.getElementById('rightJoystickContainer');
        var rightJoystickThumb = document.getElementById('rightJoystickThumb');

        // Left joystick event listeners
        leftJoystickContainer.addEventListener('touchstart', function(e) {
            e.preventDefault();
            var touch = e.targetTouches[0];
            leftJoystick.active = true;
            leftJoystick.identifier = touch.identifier;
            leftJoystick.startX = touch.pageX;
            leftJoystick.startY = touch.pageY;
            leftJoystick.x = 0;
            leftJoystick.y = 0;
        });

        leftJoystickContainer.addEventListener('touchmove', function(e) {
            e.preventDefault();
            for (var i = 0; i < e.changedTouches.length; i++) {
                var touch = e.changedTouches[i];
                if (touch.identifier === leftJoystick.identifier) {
                    leftJoystick.x = touch.pageX - leftJoystick.startX;
                    leftJoystick.y = touch.pageY - leftJoystick.startY;

                    // Limit joystick movement
                    var maxDistance = 80; // Adjusted based on new joystick size
                    var distance = Math.sqrt(leftJoystick.x * leftJoystick.x + leftJoystick.y * leftJoystick.y);
                    if (distance > maxDistance) {
                        var angle = Math.atan2(leftJoystick.y, leftJoystick.x);
                        leftJoystick.x = Math.cos(angle) * maxDistance;
                        leftJoystick.y = Math.sin(angle) * maxDistance;
                    }

                    leftJoystickThumb.style.transform = 'translate(' + leftJoystick.x + 'px, ' + leftJoystick.y + 'px)';
                    break;
                }
            }
        });

        leftJoystickContainer.addEventListener('touchend', function(e) {
            e.preventDefault();
            for (var i = 0; i < e.changedTouches.length; i++) {
                var touch = e.changedTouches[i];
                if (touch.identifier === leftJoystick.identifier) {
                    leftJoystick.active = false;
                    leftJoystick.identifier = null;
                    leftJoystick.x = 0;
                    leftJoystick.y = 0;
                    leftJoystickThumb.style.transform = 'translate(0, 0)';
                    break;
                }
            }
        });

        leftJoystickContainer.addEventListener('touchcancel', function(e) {
            e.preventDefault();
            leftJoystick.active = false;
            leftJoystick.identifier = null;
            leftJoystick.x = 0;
            leftJoystick.y = 0;
            leftJoystickThumb.style.transform = 'translate(0, 0)';
        });

        // Right joystick event listeners
        rightJoystickContainer.addEventListener('touchstart', function(e) {
            e.preventDefault();
            var touch = e.targetTouches[0];
            rightJoystick.active = true;
            rightJoystick.identifier = touch.identifier;
            rightJoystick.startX = touch.pageX;
            rightJoystick.startY = touch.pageY;
            rightJoystick.x = 0;
            rightJoystick.y = 0;
        });

        rightJoystickContainer.addEventListener('touchmove', function(e) {
            e.preventDefault();
            for (var i = 0; i < e.changedTouches.length; i++) {
                var touch = e.changedTouches[i];
                if (touch.identifier === rightJoystick.identifier) {
                    rightJoystick.x = touch.pageX - rightJoystick.startX;
                    rightJoystick.y = touch.pageY - rightJoystick.startY;

                    // Limit joystick movement
                    var maxDistance = 80; // Adjusted based on new joystick size
                    var distance = Math.sqrt(rightJoystick.x * rightJoystick.x + rightJoystick.y * rightJoystick.y);
                    if (distance > maxDistance) {
                        var angle = Math.atan2(rightJoystick.y, rightJoystick.x);
                        rightJoystick.x = Math.cos(angle) * maxDistance;
                        rightJoystick.y = Math.sin(angle) * maxDistance;
                    }

                    rightJoystickThumb.style.transform = 'translate(' + rightJoystick.x + 'px, ' + rightJoystick.y + 'px)';
                    break;
                }
            }
        });

        rightJoystickContainer.addEventListener('touchend', function(e) {
            e.preventDefault();
            for (var i = 0; i < e.changedTouches.length; i++) {
                var touch = e.changedTouches[i];
                if (touch.identifier === rightJoystick.identifier) {
                    rightJoystick.active = false;
                    rightJoystick.identifier = null;
                    rightJoystick.x = 0;
                    rightJoystick.y = 0;
                    rightJoystickThumb.style.transform = 'translate(0, 0)';
                    break;
                }
            }
        });

        rightJoystickContainer.addEventListener('touchcancel', function(e) {
            e.preventDefault();
            rightJoystick.active = false;
            rightJoystick.identifier = null;
            rightJoystick.x = 0;
            rightJoystick.y = 0;
            rightJoystickThumb.style.transform = 'translate(0, 0)';
        });

        // Start and Restart buttons
        var startButton = document.getElementById('startButton');
        var restartButton = document.getElementById('restartButton');

        startButton.addEventListener('click', function() {
            startGame();
        });

        restartButton.addEventListener('click', function() {
            restartGame();
        });

        // Main game loop
        function gameLoop(timestamp) {
            if (!gameStarted || gameOver) return;

            var deltaTime = (timestamp - lastTime) / 1000; // Convert to seconds
            lastTime = timestamp;

            update(deltaTime);
            render();

            requestAnimationFrame(gameLoop);
        }

        // Update function
        function update(deltaTime) {
            handleInput(deltaTime);
            updateProjectiles(deltaTime);
            updateEnemies(deltaTime);
            checkCollisions();

            // Level up after destroying 10 large asteroids
            if (largeAsteroidsDestroyed >= 10) {
                player.level++;
                largeAsteroidsDestroyed = 0; // Reset counter
                enemySpawnRate *= 0.9; // Enemies spawn faster
                enemySizeMultiplier += 0.1; // Enemies get larger

                // Reset player's weapon
                player.firepower = initialPlayerState.firepower;
                player.projectileSize = initialPlayerState.projectileSize;
                player.fireRate = initialPlayerState.fireRate;

                clearEnemies();
                showLevelMessage(player.level);
                updateUI();
            }
        }

        // Handle input
        function handleInput(deltaTime) {
            var baseMoveSpeed = 400; // Base movement speed

            // Keyboard controls
            if (keys['ArrowLeft']) {
                player.x -= baseMoveSpeed * deltaTime;
                player.angle = Math.PI; // Left
            }
            if (keys['ArrowRight']) {
                player.x += baseMoveSpeed * deltaTime;
                player.angle = 0; // Right
            }
            if (keys['ArrowUp']) {
                player.y -= baseMoveSpeed * deltaTime;
                player.angle = -Math.PI / 2; // Up
            }
            if (keys['ArrowDown']) {
                player.y += baseMoveSpeed * deltaTime;
                player.angle = Math.PI / 2; // Down
            }
            if (keys['Space']) {
                shoot();
            }

            // Left joystick controls movement
            if (leftJoystick.active) {
                var dx = leftJoystick.x;
                var dy = leftJoystick.y;

                var distance = Math.sqrt(dx * dx + dy * dy);
                var maxDistance = 80; // Should match the joystick's maxDistance in touchmove

                if (distance > 0) {
                    var normalizedDistance = distance / maxDistance;
                    var speedFactor = Math.pow(normalizedDistance, 2); // Less sensitive near center

                    var moveSpeed = baseMoveSpeed * speedFactor;

                    // Apply movement
                    player.x += (dx / distance) * moveSpeed * deltaTime;
                    player.y += (dy / distance) * moveSpeed * deltaTime;

                    // Set player angle for movement direction
                    player.angle = Math.atan2(dy, dx);
                }
            }

            // Right joystick controls shooting direction
            if (rightJoystick.active) {
                var dx = rightJoystick.x;
                var dy = rightJoystick.y;

                var distance = Math.sqrt(dx * dx + dy * dy);
                var maxDistance = 80; // Should match the joystick's maxDistance in touchmove

                if (distance > 0) {
                    // Set player shooting angle
                    player.shootAngle = Math.atan2(dy, dx);

                    // Shoot
                    shoot();
                }
            }

            // Mouse controls for shooting
            if (mouse.leftDown) {
                // Shoot
                shoot();
            }

            // Wrap around screen
            if (player.x < 0) player.x += canvas.width;
            if (player.x > canvas.width) player.x -= canvas.width;
            if (player.y < 0) player.y += canvas.height;
            if (player.y > canvas.height) player.y -= canvas.height;
        }

        // Shoot function
        function shoot() {
            var now = Date.now();
            if (now - player.lastShotTime > player.fireRate) {
                player.lastShotTime = now;

                var maxFirepower = 20; // Maximum firepower level
                var numProjectiles = 1 + Math.floor((player.firepower - 1) / 2); // Increase projectiles every 2 firepower
                numProjectiles = Math.min(numProjectiles, 10); // Cap the maximum number of projectiles

                var maxSpreadAngle = Math.PI / 4; // Maximum spread angle (45 degrees)
                var spreadAngle = (player.firepower / maxFirepower) * maxSpreadAngle;
                spreadAngle = Math.min(spreadAngle, maxSpreadAngle);

                var startAngle = player.shootAngle - spreadAngle / 2;
                var angleIncrement = numProjectiles > 1 ? spreadAngle / (numProjectiles - 1) : 0;

                for (var i = 0; i < numProjectiles; i++) {
                    var angle = startAngle + i * angleIncrement;
                    var projectileSpeed = 500 + player.firepower * 5; // Slightly increase speed with firepower
                    projectiles.push({
                        x: player.x,
                        y: player.y,
                        angle: angle,
                        size: player.projectileSize,
                        speed: projectileSpeed
                    });
                }

                // Decrease fire rate with increased firepower
                player.fireRate = 300 * Math.pow(0.95, player.firepower - 1);
                player.fireRate = Math.max(player.fireRate, 50); // Minimum fire rate cap
            }
        }

        // Update projectiles
        function updateProjectiles(deltaTime) {
            for (var i = projectiles.length - 1; i >= 0; i--) {
                var p = projectiles[i];
                p.x += Math.cos(p.angle) * p.speed * deltaTime;
                p.y += Math.sin(p.angle) * p.speed * deltaTime;

                // Remove projectiles that are off-screen
                if (p.x < 0 || p.x > canvas.width || p.y < 0 || p.y > canvas.height) {
                    projectiles.splice(i, 1);
                }
            }
        }

        // Update enemies
        function updateEnemies(deltaTime) {
            var now = Date.now();
            if (now - lastEnemySpawnTime > enemySpawnRate) {
                lastEnemySpawnTime = now;
                spawnEnemy();
            }

            for (var i = enemies.length - 1; i >= 0; i--) {
                var e = enemies[i];

                // Handle enemy fade out
                if (e.fadingOut) {
                    e.opacity -= deltaTime;
                    if (e.opacity <= 0) {
                        enemies.splice(i, 1);
                        continue;
                    }
                } else {
                    // Handle hit animation for 'wow' state
                    if (e.state === 'hit') {
                        e.hitDuration += deltaTime;
                        if (e.hitDuration >= 0.3) { // Shortened duration
                            // After duration, split into confused faces
                            enemies.splice(i, 1);
                            // Angry face splits into 4 confused faces
                            for (var k = 0; k < 4; k++) {
                                var angle = Math.random() * Math.PI * 2;
                                var speed = 150; // Speed for confused faces
                                enemies.push({
                                    x: e.x,
                                    y: e.y,
                                    vx: Math.cos(angle) * speed,
                                    vy: Math.sin(angle) * speed,
                                    size: e.originalSize / 2,
                                    originalSize: e.originalSize / 2,
                                    type: 'confused',
                                    state: 'normal',
                                    hitDuration: 0,
                                    lifeTime: 0, // For heart-eye emojis
                                    fading: false,
                                    blinkTimer: 0,
                                    visible: true,
                                    opacity: 1
                                });
                            }
                            continue;
                        }
                        // Enlarge the size slightly during 'wow' state
                        e.size = e.originalSize * 1.2;
                    } else {
                        // Update enemy position
                        e.x += e.vx * deltaTime;
                        e.y += e.vy * deltaTime;

                        // Only angry faces seek the player
                        if (e.type === 'angry') {
                            // Update enemy velocity to seek the player
                            var dx = player.x - e.x;
                            var dy = player.y - e.y;
                            var angleToPlayer = Math.atan2(dy, dx);

                            // Adjust velocity to move towards the player
                            var speed = e.speed;
                            e.vx = Math.cos(angleToPlayer) * speed;
                            e.vy = Math.sin(angleToPlayer) * speed;
                        }
                    }
                }

                // Handle heart-eye emoji fade out
                if (e.type === 'heart') {
                    e.lifeTime += deltaTime;
                    if (e.lifeTime >= 2 && !e.fading) {
                        e.fading = true;
                        e.blinkTimer = 0;
                    }

                    if (e.fading) {
                        e.blinkTimer += deltaTime;
                        e.opacity -= deltaTime / 3; // Fade out over 3 seconds
                        if (e.blinkTimer >= 0.3) {
                            e.visible = !e.visible;
                            e.blinkTimer = 0;
                        }
                        if (e.lifeTime >= 5 || e.opacity <= 0) {
                            enemies.splice(i, 1);
                            continue;
                        }
                    }
                }

                // Wrap around screen
                if (e.x < -e.size) e.x += canvas.width + e.size;
                if (e.x > canvas.width + e.size) e.x -= canvas.width + e.size;
                if (e.y < -e.size) e.y += canvas.height + e.size;
                if (e.y > canvas.height + e.size) e.y -= canvas.height + e.size;
            }
        }

        // Spawn enemy off-screen
        function spawnEnemy() {
            var size = 150 * enemySizeMultiplier; // Increased size each level
            var speed = (50 + 10 * player.level); // Enemies get faster each level

            // Randomly select a side to spawn from
            var side = Math.floor(Math.random() * 4); // 0: left, 1: top, 2: right, 3: bottom
            var x, y, angle;

            if (side === 0) { // Left
                x = -size;
                y = Math.random() * canvas.height;
            } else if (side === 1) { // Top
                x = Math.random() * canvas.width;
                y = -size;
            } else if (side === 2) { // Right
                x = canvas.width + size;
                y = Math.random() * canvas.height;
            } else if (side === 3) { // Bottom
                x = Math.random() * canvas.width;
                y = canvas.height + size;
            }

            // Set angle towards the player
            var dx = player.x - x;
            var dy = player.y - y;
            angle = Math.atan2(dy, dx);

            var vx = Math.cos(angle) * speed;
            var vy = Math.sin(angle) * speed;

            enemies.push({
                x: x,
                y: y,
                vx: vx,
                vy: vy,
                speed: speed,
                size: size,
                originalSize: size,
                type: 'angry', // 'angry', 'confused', 'heart', 'wow'
                state: 'normal', // 'normal', 'hit'
                hitDuration: 0, // Duration since hit
                lifeTime: 0, // For heart-eye emojis
                fading: false,
                blinkTimer: 0,
                visible: true,
                opacity: 1
            });
        }

        // Clear enemies when leveling up
        function clearEnemies() {
            // Fade out and remove all enemies
            enemies.forEach(function(e) {
                e.fadingOut = true;
            });
        }

        // Show level message
        function showLevelMessage(level) {
            var levelMessage = document.createElement('div');
            levelMessage.className = 'levelMessage';
            levelMessage.innerText = 'level ' + level;
            document.body.appendChild(levelMessage);

            // Fade in
            setTimeout(function() {
                levelMessage.style.opacity = '1';
            }, 50);

            // Fade out after 1 second
            setTimeout(function() {
                levelMessage.style.opacity = '0';
                // Remove after fade out
                setTimeout(function() {
                    document.body.removeChild(levelMessage);
                }, 1000);
            }, 1500);
        }

        // Check collisions
        function checkCollisions() {
            // Check projectile-enemy collisions
            for (var i = projectiles.length - 1; i >= 0; i--) {
                var p = projectiles[i];
                for (var j = enemies.length - 1; j >= 0; j--) {
                    var e = enemies[j];
                    var dx = p.x - e.x;
                    var dy = p.y - e.y;
                    var distance = Math.sqrt(dx * dx + dy * dy);

                    var collisionDistance = (p.size / 2) + (e.size / 2) * 0.9; // Adjusted for accuracy

                    if (distance < collisionDistance) {
                        projectiles.splice(i, 1);

                        if (e.type === 'angry' && e.state === 'normal') {
                            // Change to 'wow' state
                            e.type = 'wow';
                            e.state = 'hit';
                            e.hitDuration = 0;

                            // Increment large asteroids destroyed counter
                            largeAsteroidsDestroyed++;

                            player.score += 5;
                            updateUI();
                        } else if (e.type === 'confused') {
                            // Confused face turns into heart-eye face
                            e.type = 'heart';
                            e.lifeTime = 0;
                            e.fading = false;
                            e.visible = true;
                            e.opacity = 1;
                            player.score += 2;
                            updateUI();
                        }

                        break;
                    }
                }
            }

            // Check player-enemy collisions
            for (var i = enemies.length - 1; i >= 0; i--) {
                var e = enemies[i];
                var dx = player.x - e.x;
                var dy = player.y - e.y;
                var distance = Math.sqrt(dx * dx + dy * dy);

                var heartSize = player.size;
                if (isMobileDevice()) {
                    heartSize = player.size * 2; // Double size on mobile
                }

                var collisionDistance = (heartSize / 2) + (e.size / 2) * 0.9; // Adjusted for accuracy

                if (distance < collisionDistance) {
                    if (e.type === 'heart') {
                        // Collect heart-eye face
                        enemies.splice(i, 1);
                        player.score += 1;
                        player.projectileSize += 1;
                        player.firepower += 1; // Increase firepower
                        updateUI();
                    } else if (e.type !== 'wow') {
                        // Game over
                        gameOver = true;
                        document.getElementById('gameOver').style.display = 'block';
                        document.getElementById('restartButton').style.display = 'block';
                    }
                }
            }
        }

        // Render function
        function render() {
            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Draw player
            ctx.save();
            ctx.translate(player.x, player.y);
            ctx.rotate(player.angle + Math.PI / 2); // Rotate to pointy end forward

            var heartSize = player.size;
            if (isMobileDevice()) {
                heartSize = player.size * 2; // Double size on mobile
            }

            ctx.font = heartSize + 'px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText('â¤ï¸', 0, 0);
            ctx.restore();

            // Draw projectiles
            for (var i = 0; i < projectiles.length; i++) {
                var p = projectiles[i];
                ctx.save();
                ctx.translate(p.x, p.y);
                ctx.rotate(p.angle + Math.PI / 2);
                ctx.font = p.size + 'px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText('ðŸ’–', 0, 0);
                ctx.restore();
            }

            // Draw enemies
            for (var i = 0; i < enemies.length; i++) {
                var e = enemies[i];
                if (e.visible) {
                    ctx.save();
                    ctx.translate(e.x, e.y);
                    ctx.font = e.size + 'px Arial';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';

                    var emoji = '';
                    if (e.type === 'angry') {
                        emoji = 'ðŸ˜ ';
                    } else if (e.type === 'confused') {
                        emoji = 'ðŸ˜•';
                    } else if (e.type === 'heart') {
                        emoji = 'ðŸ˜';
                    } else if (e.type === 'wow') {
                        emoji = 'ðŸ˜®';
                    }

                    ctx.globalAlpha = e.opacity !== undefined ? e.opacity : 1;

                    ctx.fillText(emoji, 0, 0);
                    ctx.restore();
                    ctx.globalAlpha = 1; // Reset alpha
                }
            }
        }

        // Check if device is mobile
        function isMobileDevice() {
            return (typeof window.orientation !== "undefined") || (navigator.userAgent.indexOf('IEMobile') !== -1);
        }

        // Update UI elements
        function updateUI() {
            document.querySelector('#scoreboard .score').innerText = 'score: ' + player.score;
            document.querySelector('#scoreboard .level').innerText = 'level: ' + player.level;
        }

        // Start the game
        function startGame() {
            gameStarted = true;
            gameOver = false;
            player.score = 0;
            player.level = 1;
            largeAsteroidsDestroyed = 0;

            // Reset player's weapon
            player.firepower = initialPlayerState.firepower;
            player.projectileSize = initialPlayerState.projectileSize;
            player.fireRate = initialPlayerState.fireRate;

            enemySpawnRate = 2000;
            enemySizeMultiplier = 1; // Reset enemy size multiplier
            enemies = [];
            projectiles = [];
            updateUI();
            lastTime = performance.now();
            document.getElementById('startButton').style.display = 'none';
            document.getElementById('gameOver').style.display = 'none';
            document.getElementById('restartButton').style.display = 'none';
            requestAnimationFrame(gameLoop);
        }

        // Restart the game
        function restartGame() {
            gameOver = false;
            player.score = 0;
            player.level = 1;
            largeAsteroidsDestroyed = 0;

            // Reset player's weapon
            player.firepower = initialPlayerState.firepower;
            player.projectileSize = initialPlayerState.projectileSize;
            player.fireRate = initialPlayerState.fireRate;

            enemySpawnRate = 2000;
            enemySizeMultiplier = 1; // Reset enemy size multiplier
            enemies = [];
            projectiles = [];
            updateUI();
            lastTime = performance.now();
            document.getElementById('gameOver').style.display = 'none';
            document.getElementById('restartButton').style.display = 'none';
            requestAnimationFrame(gameLoop);
        }
    </script>
</body>
</html>
