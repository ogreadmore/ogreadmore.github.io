<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Science & Tech Video Stream</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            margin: 0;
        }
        h1 {
            margin-bottom: 20px;
            color: #333;
        }
        #player {
            width: 80%;
            max-width: 800px;
            height: 450px;
            margin-bottom: 10px;
            background-color: #000;
        }
        #gmtTime {
            margin-bottom: 20px;
            font-size: 18px;
            color: #555;
        }
        #playlistContainer {
            width: 80%;
            max-width: 800px;
            height: 200px;
            overflow-y: auto;
            border: 1px solid #ccc;
            background-color: #fff;
            border-radius: 5px;
        }
        #playlist {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        #playlist li {
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        #playlist li:hover {
            background-color: #f9f9f9;
        }
        #playlist li.current {
            background-color: #dcdcdc;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>Science & Tech Daily Stream</h1>
    <div id="player"></div>
    <div id="gmtTime">GMT Time: <span id="gmtClock"></span></div>
    <div id="playlistContainer">
        <ul id="playlist"></ul>
    </div>

    <script>
        let videoUrls = [];
        let videoDetails = [];
        let videoDurations = [];
        let cumulativeDurations = [];
        let currentIndex = 0;
        let player;
        let isPlayerReady = false;

        // Load YouTube IFrame API
        function loadYouTubeAPI() {
            return new Promise((resolve) => {
                const tag = document.createElement('script');
                tag.src = "https://www.youtube.com/iframe_api";
                const firstScriptTag = document.getElementsByTagName('script')[0];
                firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
                window.onYouTubeIframeAPIReady = () => {
                    resolve();
                };
            });
        }

        // Fetch playlist from CSV
        async function loadPlaylist() {
            try {
                const response = await fetch('playlist11.csv');
                const data = await response.text();
                videoUrls = data.split('\n').map(line => line.trim()).filter(Boolean);
                if (videoUrls.length === 0) throw new Error('Playlist is empty.');
            } catch (error) {
                console.error('Error loading playlist:', error);
            }
        }

        // Fetch video details and durations
        async function fetchVideoData() {
            const fetchPromises = videoUrls.map(url => fetchVideoInfo(url));
            const results = await Promise.all(fetchPromises);
            videoDetails = results.map(result => result.details);
            videoDurations = results.map(result => result.duration);
            calculateCumulativeDurations();
        }

        // Fetch individual video info
        function fetchVideoInfo(url) {
            return new Promise((resolve) => {
                const videoId = extractVideoID(url);
                const tempPlayer = new YT.Player(document.createElement('div'), {
                    videoId: videoId,
                    events: {
                        'onReady': (event) => {
                            const duration = event.target.getDuration();
                            const title = event.target.getVideoData().title || 'Unknown Title';
                            const author = event.target.getVideoData().author || 'Unknown Channel';
                            event.target.destroy();
                            resolve({
                                details: { title, author },
                                duration: duration || 3600 // Default to 1 hour if duration not available
                            });
                        },
                        'onError': () => {
                            resolve({
                                details: { title: 'Unknown Title', author: 'Unknown Channel' },
                                duration: 3600 // Default to 1 hour on error
                            });
                        }
                    }
                });
            });
        }

        // Calculate cumulative durations
        function calculateCumulativeDurations() {
            cumulativeDurations = [];
            videoDurations.reduce((acc, duration, index) => {
                cumulativeDurations[index] = acc + duration;
                return cumulativeDurations[index];
            }, 0);
        }

        // Determine current video and start time based on GMT
        function determineCurrentVideo() {
            const now = new Date();
            const secondsSinceMidnightGMT = (
                now.getUTCHours() * 3600 +
                now.getUTCMinutes() * 60 +
                now.getUTCSeconds()
            ) % cumulativeDurations[cumulativeDurations.length - 1];

            let videoIndex = cumulativeDurations.findIndex(duration => duration > secondsSinceMidnightGMT);
            if (videoIndex === -1) videoIndex = 0;

            const previousDurations = videoIndex > 0 ? cumulativeDurations[videoIndex - 1] : 0;
            const startTime = secondsSinceMidnightGMT - previousDurations;

            currentIndex = videoIndex;
            return { videoIndex, startTime };
        }

        // Initialize and play video
        function initializePlayer() {
            const { videoIndex, startTime } = determineCurrentVideo();
            const videoId = extractVideoID(videoUrls[videoIndex]);

            player = new YT.Player('player', {
                videoId: videoId,
                width: '100%',
                height: '100%',
                playerVars: {
                    autoplay: 1,
                    controls: 1,
                    start: startTime,
                    modestbranding: 1,
                    iv_load_policy: 3,
                    rel: 0
                },
                events: {
                    'onReady': () => {
                        isPlayerReady = true;
                        updatePlaylistUI();
                    },
                    'onStateChange': onPlayerStateChange,
                    'onError': () => {
                        console.error('Error playing video. Skipping to next.');
                        playNextVideo();
                    }
                }
            });
        }

        // Handle player state changes
        function onPlayerStateChange(event) {
            if (event.data === YT.PlayerState.ENDED) {
                playNextVideo();
            }
        }

        // Play next video
        function playNextVideo() {
            currentIndex = (currentIndex + 1) % videoUrls.length;
            const videoId = extractVideoID(videoUrls[currentIndex]);
            player.loadVideoById({
                videoId: videoId,
                startSeconds: 0
            });
            updatePlaylistUI();
        }

        // Extract video ID from URL
        function extractVideoID(url) {
            const regex = /(?:youtube\.com\/(?:embed\/|watch\?v=)|youtu\.be\/)([^\s&]+)/;
            const match = url.match(regex);
            return match ? match[1] : null;
        }

        // Create playlist UI
        function createPlaylistUI() {
            const playlistEl = document.getElementById('playlist');
            playlistEl.innerHTML = '';
            videoDetails.forEach((detail, index) => {
                const listItem = document.createElement('li');
                listItem.textContent = `${detail.title} - ${detail.author}`;
                listItem.dataset.index = index;
                listItem.addEventListener('click', () => {
                    currentIndex = index;
                    player.loadVideoById({
                        videoId: extractVideoID(videoUrls[currentIndex]),
                        startSeconds: 0
                    });
                    updatePlaylistUI();
                });
                playlistEl.appendChild(listItem);
            });
            updatePlaylistUI();
        }

        // Update playlist UI highlighting
        function updatePlaylistUI() {
            const playlistItems = document.querySelectorAll('#playlist li');
            playlistItems.forEach(item => {
                item.classList.toggle('current', parseInt(item.dataset.index) === currentIndex);
            });
            // Scroll to current item
            const currentItem = document.querySelector('#playlist li.current');
            if (currentItem) {
                currentItem.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        }

        // Update GMT clock
        function updateGMTClock() {
            const now = new Date();
            const gmtTime = now.toUTCString().split(' ')[4];
            document.getElementById('gmtClock').textContent = gmtTime;
        }

        // Initialize application
        async function init() {
            await loadYouTubeAPI();
            await loadPlaylist();
            await fetchVideoData();
            createPlaylistUI();
            initializePlayer();
            updateGMTClock();
            setInterval(updateGMTClock, 1000);
        }

        // Start application
        init();
    </script>
</body>
</html>
